<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Conversation - Discussion & Rating</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .category-selector {
            margin-bottom: 30px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .category-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .category-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .category-card.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .category-card.completed {
            background: #4ade80;
            color: white;
            border-color: #4ade80;
        }

        .category-card.completed::after {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .category-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .category-name {
            font-size: 13px;
            font-weight: 600;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }

        .question-container {
            margin-bottom: 30px;
        }

        .category-badge {
            display: inline-block;
            background: #e9ecef;
            color: #667eea;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 22px;
            font-weight: 600;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.4;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 12px;
        }

        .discussion-prompt {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            font-size: 14px;
            color: #856404;
        }

        .rating-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 600;
            color: #666;
        }

        .mode-btn:hover {
            background: #f8f9fa;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .rating-section {
            margin-bottom: 25px;
        }

        .rating-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .person-label {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .rating-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: #e9ecef;
            color: #666;
        }

        .rating-status.completed {
            background: #4ade80;
            color: white;
        }

        .rating-stars {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .star {
            font-size: 40px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .star:hover {
            transform: scale(1.2);
        }

        .star.filled {
            color: #ffd700;
        }

        .star.empty {
            color: #e9ecef;
        }

        .rating-label {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            font-weight: 600;
            min-height: 24px;
        }

        .reveal-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
            text-align: center;
        }

        .reveal-section h3 {
            color: #0369a1;
            margin-bottom: 15px;
        }

        .revealed-ratings {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            gap: 20px;
        }

        .revealed-rating {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 12px;
        }

        .revealed-rating-person {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .revealed-rating-stars {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .revealed-rating-label {
            font-size: 12px;
            color: #666;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .btn-success {
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }

        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .navigation-buttons .btn {
            margin-top: 0;
        }

        .results {
            text-align: center;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 30px auto;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .score-number {
            font-size: 60px;
            font-weight: 700;
        }

        .score-label {
            font-size: 18px;
            opacity: 0.9;
        }

        .compatibility-message {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
            margin: 20px 0;
        }

        .category-breakdown {
            text-align: left;
            margin-top: 30px;
        }

        .category-result {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .category-score {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .question-result {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #e9ecef;
        }

        .question-result.high-alignment {
            border-left-color: #4ade80;
            background: #f0fdf4;
        }

        .question-result.medium-alignment {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }

        .question-result.low-alignment {
            border-left-color: #f87171;
            background: #fef2f2;
        }

        .question-result-text {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .ratings-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 8px;
        }

        .person-rating {
            font-size: 13px;
            color: #666;
        }

        .intro-screen {
            text-align: center;
            padding: 20px 0;
        }

        .intro-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .intro-text {
            font-size: 16px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .rating-guide {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .rating-guide h3 {
            color: #0369a1;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .rating-guide-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #334155;
        }

        .rating-guide-stars {
            margin-right: 10px;
            color: #ffd700;
        }

        .mode-explanation {
            background: #f0fdf4;
            border-left: 4px solid #4ade80;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #166534;
        }

        .completed-categories-banner {
            background: #f0fdf4;
            border: 2px solid #4ade80;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .completed-categories-banner h3 {
            color: #166534;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .rating-collection-notice {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            color: #0369a1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" id="app">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>

    <script>
        const questionCategories = [
            {
                id: 'values',
                name: 'Values & Core Beliefs',
                icon: 'üéØ',
                description: 'What guides your choices when things get hard',
                weight: 3,
                questions: [
                    "What values do you refuse to compromise on?",
                    "What principles guide your decisions in relationships?",
                    "What does being a good person mean to you?",
                    "When have your values been tested the most?",
                    "What kind of behavior instantly makes you lose respect for someone?",
                    "What do you believe you owe a partner?",
                    "What do you think a partner owes you?",
                    "How important is honesty, even when it hurts?",
                    "How do you define loyalty?",
                    "What do you believe about forgiveness?",
                    "How do you feel about moral gray areas?",
                    "What values did you inherit from your family‚Äîand which did you reject?",
                    "What do you think love should feel like long-term?",
                    "What belief about relationships changed as you got older?",
                    "What kind of life feels 'right' to you?"
                    
                ]
            },
            {
                id: 'emotional',
                name: 'Emotional Availability',
                icon: 'üí≠',
                description: 'Can you feel, reflect, and take responsibility?',
                weight: 3,
                questions: [
                    "How do you usually process difficult emotions?",
                    "What emotions are hardest for you to express?",
                    "How do you react when you're overwhelmed?",
                    "How do you calm yourself when you're upset?",
                    "What have past relationships taught you about yourself?",
                    "How do you know when you‚Äôre emotionally shutting down?",
                    "What triggers you the most?",
                    "How do you repair after hurting someone?",
                    "What does emotional support look like to you?",
                    "How do you ask for help?",
                    "What‚Äôs something you‚Äôre actively working on emotionally?",
                    "How do you handle guilt or shame?",
                    "Do you reflect after conflicts‚Äîor avoid them?",
                    "How do you handle vulnerability?",
                    "What does emotional safety mean to you?"
                ]
            },
            {
                id: 'communication',
                name: 'Communication Style',
                icon: 'üí¨',
                description: 'How conflict actually plays out',
                weight: 3,
                questions: [
                    "How do you usually handle disagreements?",
                    "Do you prefer to talk things out immediately or take space first?",
                    "How do you feel about difficult conversations?",
                    "What communication habits frustrate you?",
                    "How do you express needs?",
                    "How do you respond when someone criticizes you?",
                    "What makes you feel unheard?",
                    "How do you handle misunderstandings?",
                    "Are you more direct or indirect when upset?",
                    "How do you apologize?",
                    "What does 'healthy communication' mean to you?",
                    "How do you feel about silence during conflict?",
                    "How do you express affection verbally?",
                    "How do you react when emotions run high?",
                    "What communication pattern do you want to avoid repeating?"
                ]
            },
            {
                id: 'attachment',
                name: 'Love & Intimacy',
                icon: '‚ù§Ô∏è',
                description: 'How you bond and stay connected',
                weight: 3,
                questions: [
                    "How do you usually fall in love?",
                    "What makes you feel most loved?",
                    "What makes you feel insecure in relationships?",
                    "How do you react when you feel distant from a partner?",
                    "What does commitment mean to you?",
                    "How do you show love day-to-day?",
                    "What makes you feel emotionally close?",
                    "How do you handle jealousy?",
                    "What scares you most about intimacy?",
                    "How do you handle dependence vs independence?",
                    "What role does reassurance play for you?",
                    "How do you feel about physical affection?",
                    "What breaks intimacy for you?",
                    "How do you maintain connection over time?",
                    "What does ‚Äúbeing chosen‚Äù feel like to you?"
                ]
            },
            {
                id: 'past',
                name: 'Past Relationships',
                icon: 'üìñ',
                description: 'Patterns matter more than stories',
                weight: 2,
                questions: [
                    "How many serious relationships have you had?",
                    "Why did your last relationship end?",
                    "What part did you play in that ending?",
                    "What pattern do you notice in your past relationships?",
                    "What did you tolerate that you wouldn't now?",
                    "What wounds are you still healing?",
                    "How do you talk about your exes?",
                    "What mistake do you not want to repeat?",
                    "What did you learn about love the hard way?",
                    "Are you still emotionally tied to anyone?",
                    "What unresolved issues do you carry?",
                    "How has loss or heartbreak changed you?",
                    "What growth came from your past relationships?",
                    "What kind of partner were you before‚Äîand now?",
                    "Are you ready for something new now?"
                ]
            },
            {
                id: 'goals',
                name: 'Life Goals & Direction',
                icon: 'üéØ',
                description: 'Walking toward compatible futures?',
                weight: 3,
                questions: [
                    "What does a fulfilling life look like to you?",
                    "Where do you see yourself in 5‚Äì10 years?",
                    "What are you currently working toward?",
                    "How important is ambition to you?",
                    "How do you define success?",
                    "What role does a partner play in your life goals?",
                    "Do you prioritize stability or freedom?",
                    "How do you feel about routine vs change?",
                    "What dreams feel non-negotiable?",
                    "What goals are flexible?",
                    "How do you handle setbacks?",
                    "What motivates you to keep going?",
                    "What sacrifices are you willing to make for love?",
                    "What sacrifices are you not willing to make?",
                    "Do you see partnership as teamwork or support?"
                ]
            },
            {
                id: 'finances',
                name: 'Finances & Work',
                icon: 'üí∞',
                description: 'Love doesn\'t erase money stress',
                weight: 2,
                questions: [
                    "How do you feel about money?",
                    "How do you usually manage your finances?",
                    "Are you more of a saver or spender?",
                    "What financial habits are you proud of?",
                    "What financial habits concern you?",
                    "How do you handle financial stress?",
                    "What role does money play in relationships?",
                    "How do you feel about sharing finances?",
                    "What does financial security mean to you?",
                    "How do you feel about debt?",
                    "How do you prioritize work vs life?",
                    "What does a ‚Äúgood job‚Äù mean to you?",
                    "How do you feel about supporting a partner‚Äîor being supported?",
                    "What financial boundaries do you need?",
                    "What financial conflicts worry you most?"
                ]
            },
            {
                id: 'family',
                name: 'Family & Upbringing',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                description: 'You date their history too',
                weight: 2,
                questions: [
                    "How would you describe your childhood?",
                    "What family patterns shaped you most?",
                    "How close are you to your family?",
                    "What family dynamics do you struggle with?",
                    "What traditions matter to you?",
                    "How did your parents model relationships?",
                    "What family values do you want to keep?",
                    "Which ones do you want to break?",
                    "How do you handle family conflict?",
                    "What role does family play in your decisions?",
                    "How do you feel about chosen family?",
                    "What boundaries do you need with relatives?",
                    "How do you show care within family?",
                    "How do you handle family expectations?",
                    "What scares you about blending lives?"
                ]
            },
            {
                id: 'boundaries',
                name: 'Boundaries & Respect',
                icon: 'üõ°Ô∏è',
                description: 'Love without boundaries isn\'t love',
                weight: 3,
                questions: [
                    "What boundaries are most important to you?",
                    "How do you enforce boundaries?",
                    "How do you react when someone says NO?",
                    "What behaviors feel disrespectful to you?",
                    "How much independence do you need?",
                    "How do you handle time apart?",
                    "What makes you feel controlled?",
                    "How do you respect a partner‚Äôs space?",
                    "What are your deal-breakers?",
                    "How do you handle crossed boundaries?",
                    "How do you assert your needs?",
                    "What does mutual respect look like?",
                    "How do you balance closeness and freedom?",
                    "What boundaries did you learn too late?",
                    "What boundaries are non-negotiable now?"
                ]
            },
            {
                id: 'conflict',
                name: 'Conflict & Crisis',
                icon: '‚ö°',
                description: 'Where compatibility is proven',
                weight: 3,
                questions: [
                    "How do you react under stress?",
                    "What happens when you feel attacked?",
                    "How do you behave when you‚Äôre hurt?",
                    "Do you escalate or withdraw during conflict?",
                    "How do you cool down after arguments?",
                    "What does a 'fair fight' look like to you?",
                    "How do you repair after conflict?",
                    "How do you handle emotional overload?",
                    "What kind of support do you want in crises?",
                    "How do you support others under stress?",
                    "How do you handle uncertainty?",
                    "What coping mechanisms do you rely on?",
                    "What makes conflict feel unsafe to you?",
                    "How do you rebuild trust?",
                    "What do you need after a hard moment?"
                ]
            },
            {
                id: 'lifestyle',
                name: 'Daily Lifestyle',
                icon: 'üè†',
                description: 'Love lives in the ordinary',
                weight: 2,
                questions: [
                    "What does an ideal day look like?",
                    "How do you like to spend your free time?",
                    "How social are you?",
                    "How important is alone time?",
                    "How do you balance rest and activity?",
                    "What habits are non-negotiable for you?",
                    "How do you feel about routines?",
                    "What role does health play in your life?",
                    "How do you handle mess vs order?",
                    "What does 'home' mean to you?",
                    "How do you recharge?",
                    "How flexible are you day-to-day?",
                    "What lifestyle differences concern you?",
                    "What lifestyle similarities matter most?",
                    "What daily habits help you thrive?"
                ]
            },
            {
                id: 'commitment',
                name: 'Commitment & Vision',
                icon: 'üíç',
                description: 'The bottom-line clarity',
                weight: 3,
                questions: [
                    "What does being 'in a relationship' mean to you?",
                    "What makes someone your person?",
                    "What would make you walk away?",
                    "What are your absolute deal-breakers?",
                    "What are you willing to work through?",
                    "How do you know when to stay vs leave?",
                    "What scares you about long-term commitment?",
                    "What excites you about it?",
                    "How do you define partnership?",
                    "What does growth together look like?",
                    "How do you want love to evolve?",
                    "What promises matter most to you?",
                    "How do you envision building a life together?",
                    "What kind of relationship do you not want?",
                    "What would make this relationship worth choosing every day?"
                ]
            }
        ];

        class DeepConversationApp {
            constructor() {
                this.selectedCategory = null; // Only one category at a time
                this.completedCategories = []; // Categories that have been fully rated
                this.currentQuestionIndex = 0;
                this.ratings = {}; // { categoryId_questionIndex: { person1: rating, person2: rating } }
                this.currentRatingPerson = null;
                this.stage = 'intro'; // intro, categorySelect, questions, results
                this.render();
            }

            getCurrentRatingKey() {
                return `${this.selectedCategory}_${this.currentQuestionIndex}`;
            }

            isCategoryComplete(categoryId) {
                return this.completedCategories.includes(categoryId);
            }

            getAllRatedCategories() {
                // Get all categories that have at least one rating
                const ratedCategories = new Set();
                Object.keys(this.ratings).forEach(key => {
                    const categoryId = key.split('_')[0];
                    ratedCategories.add(categoryId);
                });
                return Array.from(ratedCategories);
            }

            render() {
                const app = document.getElementById('app');
                
                switch(this.stage) {
                    case 'intro':
                        app.innerHTML = this.renderIntro();
                        this.attachIntroListeners();
                        break;
                    case 'categorySelect':
                        app.innerHTML = this.renderCategorySelect();
                        this.attachCategoryListeners();
                        break;
                    case 'questions':
                        app.innerHTML = this.renderQuestion();
                        this.attachQuestionListeners();
                        break;
                    case 'results':
                        app.innerHTML = this.renderResults();
                        this.attachResultsListeners();
                        break;
                }
            }

            renderIntro() {
                return `
                    <h1>üíï Deep Conversation</h1>
                    <p class="subtitle">A discussion-based compatibility assessment</p>
                    
                    <div class="intro-screen">
                        <div class="intro-icon">üó£Ô∏è</div>
                        <h2 style="color: #667eea; margin-bottom: 20px;">Talk It Through Together</h2>
                        <div class="intro-text">
                            This is a conversation-based compatibility tool with <strong>private ratings</strong>:
                            <br><br>
                            <strong>üì± Read each question out loud</strong>
                            <br>
                            <strong>üó®Ô∏è Both share your answers verbally</strong>
                            <br>
                            <strong>‚≠ê Rate privately (one at a time)</strong>
                            <br>
                            <strong>üîì Reveal all ratings at the end</strong>
                            <br><br>
                            Complete one category at a time. All ratings are revealed together 
                            when you finish the category!
                        </div>

                        <div class="rating-guide">
                            <h3>‚≠ê Rating Guide:</h3>
                            <div class="rating-guide-item">
                                <span class="rating-guide-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                Perfect alignment - Exactly what I need to hear
                            </div>
                            <div class="rating-guide-item">
                                <span class="rating-guide-stars">‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                Strong alignment - I really like this answer
                            </div>
                            <div class="rating-guide-item">
                                <span class="rating-guide-stars">‚≠ê‚≠ê‚≠ê</span>
                                Good enough - I can work with this
                            </div>
                            <div class="rating-guide-item">
                                <span class="rating-guide-stars">‚≠ê‚≠ê</span>
                                Some concerns - Not quite what I'm looking for
                            </div>
                            <div class="rating-guide-item">
                                <span class="rating-guide-stars">‚≠ê</span>
                                Red flag - This is a problem for me
                            </div>
                        </div>
                        
                        <button class="btn" id="startBtn">Begin Conversation</button>
                    </div>
                `;
            }

            renderCategorySelect() {
                return `
                    <h1>üíï Deep Conversation</h1>
                    <p class="subtitle">Select one category to explore</p>
                    
                    ${this.completedCategories.length > 0 ? `
                        <div class="completed-categories-banner">
                            <h3>‚úÖ ${this.completedCategories.length} ${this.completedCategories.length === 1 ? 'Category' : 'Categories'} Completed</h3>
                            <p style="font-size: 14px; color: #166534; margin-top: 5px;">
                                Select another category to continue or view your results
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="category-selector">
                        <p style="margin-bottom: 15px; color: #666; text-align: center;">
                            Choose one category (you can add more later)
                        </p>
                        
                        <div class="category-grid">
                            ${questionCategories.map(cat => {
                                const isCompleted = this.completedCategories.includes(cat.id);
                                const isSelected = this.selectedCategory === cat.id;
                                return `
                                    <div class="category-card ${isSelected ? 'selected' : ''} ${isCompleted ? 'completed' : ''}" 
                                         data-category="${cat.id}">
                                        <div class="category-icon">${cat.icon}</div>
                                        <div class="category-name">${cat.name}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <button class="btn" id="continueBtn" ${!this.selectedCategory ? 'disabled' : ''}>
                        Start Category
                    </button>
                    
                    ${this.completedCategories.length > 0 ? `
                        <button class="btn btn-success" id="viewResultsBtn" style="margin-top: 10px;">
                            üìä View Results (${this.completedCategories.length} ${this.completedCategories.length === 1 ? 'Category' : 'Categories'})
                        </button>
                    ` : ''}
                `;
            }

            renderQuestion() {
                const category = questionCategories.find(c => c.id === this.selectedCategory);
                const question = category.questions[this.currentQuestionIndex];
                const totalQuestions = category.questions.length;
                const progress = ((this.currentQuestionIndex + 1) / totalQuestions) * 100;
                
                const ratingKey = this.getCurrentRatingKey();
                const currentRatings = this.ratings[ratingKey] || { person1: 0, person2: 0 };
                
                const bothRated = currentRatings.person1 > 0 && currentRatings.person2 > 0;

                return `
                    <h1>üíï Deep Conversation</h1>
                    <p class="subtitle">Discuss together, rate privately</p>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>

                    <div style="text-align: center; color: #666; margin-bottom: 20px;">
                        Question ${this.currentQuestionIndex + 1} of ${totalQuestions}
                    </div>

                    <div class="question-container">
                        <div class="category-badge">
                            ${category.icon} ${category.name}
                        </div>
                        
                        <div class="question-text">${question}</div>
                        
                        <div class="rating-collection-notice">
                            üîí Ratings are private. All answers will be revealed when you complete the category.
                        </div>

                        <div class="discussion-prompt">
                            üí° <strong>Step 1:</strong> Both share your answers out loud
                            <br>
                            <strong>Step 2:</strong> Take turns rating each other privately
                        </div>

                        ${!this.currentRatingPerson ? `
                            <div class="mode-explanation">
                                Choose who rates first. Pass the phone when done.
                            </div>
                            
                            <div class="rating-mode-selector">
                                <button class="mode-btn" id="selectPerson1">
                                    üë§ Person 1 Rates First
                                </button>
                                <button class="mode-btn" id="selectPerson2">
                                    üë• Person 2 Rates First
                                </button>
                            </div>
                        ` : `
                            <div class="rating-section">
                                <div class="rating-header">
                                    <span class="person-label">
                                        ${this.currentRatingPerson === 'person1' ? 'üë§ Person 1 Rating' : 'üë• Person 2 Rating'}
                                    </span>
                                    <span class="rating-status ${currentRatings[this.currentRatingPerson] > 0 ? 'completed' : ''}">
                                        ${currentRatings[this.currentRatingPerson] > 0 ? '‚úì Rated' : 'Rating...'}
                                    </span>
                                </div>
                                <div class="rating-stars" id="rating-stars">
                                    ${this.renderStars(currentRatings[this.currentRatingPerson], this.currentRatingPerson)}
                                </div>
                                <div class="rating-label" id="rating-label">
                                    ${this.getRatingLabel(currentRatings[this.currentRatingPerson])}
                                </div>
                            </div>

                            ${currentRatings[this.currentRatingPerson] > 0 ? `
                                <button class="btn" id="confirmRatingBtn">
                                    ${!bothRated ? 
                                        (this.currentRatingPerson === 'person1' ? 'Pass to Person 2 ‚Üí' : 'Pass to Person 1 ‚Üí') :
                                        (this.currentQuestionIndex === totalQuestions - 1 ? 'Complete & Reveal All üîì' : 'Next Question ‚Üí')}
                                </button>
                            ` : ''}
                        `}
                    </div>
                `;
            }

            renderStars(rating, person) {
                let html = '';
                for (let i = 1; i <= 5; i++) {
                    html += `<span class="star ${i <= rating ? 'filled' : 'empty'}" data-person="${person}" data-rating="${i}">‚≠ê</span>`;
                }
                return html;
            }

            getRatingLabel(rating) {
                const labels = {
                    0: 'Tap stars to rate',
                    1: '‚ö†Ô∏è Red flag',
                    2: 'ü§î Some concerns',
                    3: 'üëç Good enough',
                    4: 'üíö Strong alignment',
                    5: 'üíñ Perfect alignment'
                };
                return labels[rating] || '';
            }

            renderResults() {
                const analysis = this.analyzeCompatibility();
                
                return `
                    <h1>üíï Deep Conversation</h1>
                    <p class="subtitle">Your Compatibility Analysis</p>
                    
                    <div class="results">
                        <div class="score-circle">
                            <div class="score-number">${analysis.overallScore}%</div>
                            <div class="score-label">Compatible</div>
                        </div>
                        
                        <div class="compatibility-message">
                            ${analysis.message}
                        </div>
                        
                        <p style="color: #666; margin: 20px 0;">
                            ${analysis.summary}
                        </p>
                        
                        <div style="display: flex; justify-content: space-around; margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #667eea;">${analysis.person1AvgRating.toFixed(1)}</div>
                                <div style="font-size: 14px; color: #666;">Person 1's Avg Rating</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #764ba2;">${analysis.person2AvgRating.toFixed(1)}</div>
                                <div style="font-size: 14px; color: #666;">Person 2's Avg Rating</div>
                            </div>
                        </div>
                        
                        <div class="category-breakdown">
                            <h3 style="margin-bottom: 20px; color: #667eea; text-align: left;">
                                üìä Category Breakdown (${this.completedCategories.length} ${this.completedCategories.length === 1 ? 'Category' : 'Categories'})
                            </h3>
                            ${this.renderCategoryBreakdown(analysis)}
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button class="btn btn-secondary" id="addMoreBtn" style="flex: 1; margin-top: 0;">
                                ‚ûï Add Another Category
                            </button>
                            <button class="btn" id="restartBtn" style="flex: 1; margin-top: 0;">
                                üîÑ Start Over
                            </button>
                        </div>
                    </div>
                `;
            }

            renderCategoryBreakdown(analysis) {
                return analysis.categories.map(cat => {
                    const category = questionCategories.find(c => c.id === cat.id);
                    return `
                        <div class="category-result">
                            <div class="category-header">
                                <div class="category-title">
                                    ${category.icon} ${category.name}
                                </div>
                                <div class="category-score">${cat.score}%</div>
                            </div>
                            ${this.renderQuestionResults(cat.id, category)}
                        </div>
                    `;
                }).join('');
            }

            renderQuestionResults(categoryId, category) {
                const html = [];
                
                category.questions.forEach((question, idx) => {
                    const key = `${categoryId}_${idx}`;
                    const ratings = this.ratings[key];
                    
                    if (!ratings) return;
                    
                    const avgRating = (ratings.person1 + ratings.person2) / 2;
                    const difference = Math.abs(ratings.person1 - ratings.person2);
                    
                    let alignmentClass = 'low-alignment';
                    let alignmentIcon = '‚ùå';
                    if (avgRating >= 4 && difference <= 1) {
                        alignmentClass = 'high-alignment';
                        alignmentIcon = '‚úÖ';
                    } else if (avgRating >= 3) {
                        alignmentClass = 'medium-alignment';
                        alignmentIcon = '‚ö†Ô∏è';
                    }
                    
                    html.push(`
                        <div class="question-result ${alignmentClass}">
                            <div class="question-result-text">
                                ${alignmentIcon} ${question}
                            </div>
                            <div class="ratings-display">
                                <span class="person-rating">
                                    üë§ Person 1 rated: ${'‚≠ê'.repeat(ratings.person1)}
                                </span>
                                <span class="person-rating">
                                    üë• Person 2 rated: ${'‚≠ê'.repeat(ratings.person2)}
                                </span>
                            </div>
                        </div>
                    `);
                });
                
                return html.join('');
            }

            analyzeCompatibility() {
                const categoryScores = [];
                let totalWeight = 0;
                let weightedScore = 0;
                let person1Total = 0;
                let person2Total = 0;
                let ratingCount = 0;

                this.completedCategories.forEach(catId => {
                    const category = questionCategories.find(c => c.id === catId);
                    const questions = category.questions;
                    let categoryScore = 0;
                    let categoryCount = 0;

                    questions.forEach((q, idx) => {
                        const key = `${catId}_${idx}`;
                        const ratings = this.ratings[key];
                        
                        if (ratings) {
                            const avgRating = (ratings.person1 + ratings.person2) / 2;
                            categoryScore += (avgRating / 5) * 100;
                            categoryCount++;
                            
                            person1Total += ratings.person1;
                            person2Total += ratings.person2;
                            ratingCount++;
                        }
                    });

                    const categoryPercentage = categoryCount > 0 ? Math.round(categoryScore / categoryCount) : 0;
                    categoryScores.push({ id: catId, score: categoryPercentage });
                    
                    weightedScore += categoryPercentage * category.weight;
                    totalWeight += category.weight;
                });

                const overallScore = totalWeight > 0 ? Math.round(weightedScore / totalWeight) : 0;
                const person1AvgRating = ratingCount > 0 ? person1Total / ratingCount : 0;
                const person2AvgRating = ratingCount > 0 ? person2Total / ratingCount : 0;
                
                let message, summary;
                if (overallScore >= 80) {
                    message = "üî• Exceptional Alignment";
                    summary = "You both rated each other's answers very highly. There's strong mutual appreciation for how each of you approaches life and relationships.";
                } else if (overallScore >= 65) {
                    message = "üíñ Strong Connection";
                    summary = "Your ratings show good compatibility. You appreciate each other's perspectives even if you don't always see things the same way.";
                } else if (overallScore >= 50) {
                    message = "üíõ Meaningful Potential";
                    summary = "Mixed ratings suggest areas of alignment and some differences. Open communication will be key to navigating these differences.";
                } else {
                    message = "ü§î Different Perspectives";
                    summary = "Lower ratings indicate significant differences in values or approaches. Consider whether these differences are complementary or concerning.";
                }

                return {
                    overallScore,
                    message,
                    summary,
                    categories: categoryScores,
                    person1AvgRating,
                    person2AvgRating
                };
            }

            attachIntroListeners() {
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.stage = 'categorySelect';
                    this.render();
                });
            }

            attachCategoryListeners() {
                const cards = document.querySelectorAll('.category-card');
                cards.forEach(card => {
                    card.addEventListener('click', () => {
                        const catId = card.dataset.category;
                        
                        // Don't allow selecting already completed categories
                        if (this.completedCategories.includes(catId)) {
                            return;
                        }
                        
                        // Only one category can be selected at a time
                        this.selectedCategory = this.selectedCategory === catId ? null : catId;
                        
                        this.render();
                    });
                });

                const continueBtn = document.getElementById('continueBtn');
                if (continueBtn) {
                    continueBtn.addEventListener('click', () => {
                        this.stage = 'questions';
                        this.currentQuestionIndex = 0;
                        this.currentRatingPerson = null;
                        this.render();
                    });
                }

                const viewResultsBtn = document.getElementById('viewResultsBtn');
                if (viewResultsBtn) {
                    viewResultsBtn.addEventListener('click', () => {
                        this.stage = 'results';
                        this.render();
                    });
                }
            }

            attachQuestionListeners() {
                const selectPerson1 = document.getElementById('selectPerson1');
                const selectPerson2 = document.getElementById('selectPerson2');
                
                if (selectPerson1) {
                    selectPerson1.addEventListener('click', () => {
                        this.currentRatingPerson = 'person1';
                        this.render();
                    });
                }
                
                if (selectPerson2) {
                    selectPerson2.addEventListener('click', () => {
                        this.currentRatingPerson = 'person2';
                        this.render();
                    });
                }

                const stars = document.querySelectorAll('.star');
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const person = star.dataset.person;
                        const rating = parseInt(star.dataset.rating);
                        
                        const ratingKey = this.getCurrentRatingKey();
                        
                        if (!this.ratings[ratingKey]) {
                            this.ratings[ratingKey] = { person1: 0, person2: 0 };
                        }
                        
                        this.ratings[ratingKey][person] = rating;
                        this.render();
                    });
                });

                const confirmRatingBtn = document.getElementById('confirmRatingBtn');
                if (confirmRatingBtn) {
                    confirmRatingBtn.addEventListener('click', () => {
                        const ratingKey = this.getCurrentRatingKey();
                        const currentRatings = this.ratings[ratingKey];
                        
                        // Check if both have rated
                        if (currentRatings.person1 > 0 && currentRatings.person2 > 0) {
                            // Check if this is the last question
                            const category = questionCategories.find(c => c.id === this.selectedCategory);
                            if (this.currentQuestionIndex === category.questions.length - 1) {
                                // Last question - complete category and show results
                                this.completeCurrentCategory();
                            } else {
                                // Not last question - move to next
                                this.moveToNextQuestion();
                            }
                        } else {
                            // Switch to other person
                            this.currentRatingPerson = this.currentRatingPerson === 'person1' ? 'person2' : 'person1';
                            this.render();
                        }
                    });
                }
            }

            completeCurrentCategory() {
                // Mark current category as completed
                if (!this.completedCategories.includes(this.selectedCategory)) {
                    this.completedCategories.push(this.selectedCategory);
                }
                
                // Show results
                this.stage = 'results';
                this.render();
            }

            moveToNextQuestion() {
                this.currentQuestionIndex++;
                this.currentRatingPerson = null;
                this.render();
            }

            attachResultsListeners() {
                const addMoreBtn = document.getElementById('addMoreBtn');
                if (addMoreBtn) {
                    addMoreBtn.addEventListener('click', () => {
                        // Reset current category but keep ratings and completed categories
                        this.selectedCategory = null;
                        this.stage = 'categorySelect';
                        this.render();
                    });
                }

                const restartBtn = document.getElementById('restartBtn');
                if (restartBtn) {
                    restartBtn.addEventListener('click', () => {
                        this.selectedCategory = null;
                        this.completedCategories = [];
                        this.currentQuestionIndex = 0;
                        this.ratings = {};
                        this.currentRatingPerson = null;
                        this.stage = 'intro';
                        this.render();
                    });
                }
            }
        }

        // Initialize the app
        new DeepConversationApp();
    </script>
</body>
</html>

